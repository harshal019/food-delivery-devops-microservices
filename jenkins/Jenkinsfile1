pipeline {
    agent any
    tools {
        jdk 'jdk17'
        nodejs 'node23'
    }
    environment {
        SCANNER_HOME = tool 'sonar-scanner'
        DOCKER_IMAGE = 'harshalg01/zomato-app:latest'
        EKS_CLUSTER_NAME = 'zomato-cluster'
        AWS_REGION = 'us-east-2'
    }

    stages {

        stage ("clean workspace") {
            steps {
                cleanWs()
            }
        }

        stage ("Git Checkout") {
            steps {
                git 'https://github.com/harshal019/food-delivery-devops-microservices.git'           
                 }
        }
        

        stage("Deploy to Kubernetes") {
            steps {
                withCredentials([[
                    $class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: 'aws-creds'
                ]]) {

                    sh "aws eks update-kubeconfig --region ${AWS_REGION} --name ${EKS_CLUSTER_NAME}"

                    dir("k8s") {
                        sh """
                            kubectl apply -f deployment.yaml
                            kubectl apply -f service.yaml
                            kubectl apply -f hpa.yaml
                        """
                    }
                }
            }
    }

        }


        stage("Verify Deployment") {
            steps {
                sh """
                    kubectl rollout status deployment/zomato-app
                    kubectl get pods
                    kubectl get svc
                    kubectl get hpa
                """
            }
        }
}

    post {
        always {
            emailext(
                subject: "${currentBuild.currentResult}: Job ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                    <html>
                    <body>
                        <div style="background-color: #FFA07A; padding: 10px; margin-bottom: 10px;">
                            <p style="color: white; font-weight: bold;">Project: ${env.JOB_NAME}</p>
                        </div>
                        <div style="background-color: #90EE90; padding: 10px; margin-bottom: 10px;">
                            <p style="color: white; font-weight: bold;">Build Number: ${env.BUILD_NUMBER}</p>
                        </div>
                        <div style="background-color: #87CEEB; padding: 10px; margin-bottom: 10px;">
                            <p style="color: white; font-weight: bold;">URL: ${env.BUILD_URL}</p>
                        </div>
                    </body>
                    </html>
                """,
                to: "harshaldgharat01@gmail.com",
                mimeType: "text/html",
                attachLog: true,
                attachmentsPattern: "trivy*.txt"
            )
        }
    }

}
